# üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - 2025-11-16
**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** 2025-11-16
**Commit ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:** `a925de4` - "‚úÖ COMPLETE FIX: ‡πÅ‡∏Å‡πâ‡∏ó‡∏∏‡∏Å layout ‡πÉ‡∏ä‡πâ scale ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô"

---

## üî• ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö

### 1. ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Layout ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ä‡πâ scale ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (0.75x, 0.95x, 1.15x, 1.3x)
- **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:** ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏ï‡∏±‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å (‡πÄ‡∏ä‡πà‡∏ô tri_pyramid: ‡∏Å‡∏•‡∏≤‡∏á 1.3x, ‡∏Ç‡πâ‡∏≤‡∏á 0.75x)
- **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á log:**
  - secondary_1: scale=0.75x (‡πÄ‡∏•‡πá‡∏Å)
  - main: scale=1.3x (‡πÉ‡∏´‡∏ç‡πà)
  - secondary_2: scale=0.75x (‡πÄ‡∏•‡πá‡∏Å)

### 2. ‡∏ï‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Layout ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ä‡πâ position.y ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (0.12, 0.25, 0.30, 0.35)
- **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:** ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏™‡∏π‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
- **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:** duo_diagonal ‡πÉ‡∏ä‡πâ y=0.12 ‡πÅ‡∏•‡∏∞ y=0.25

### 3. ‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏î
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å:**
  1. TOP_MARGIN = 100px ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
  2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì `eye_y_in_crop` **‡∏Å‡πà‡∏≠‡∏ô** boundary check ‚Üí ‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î!
  3. TARGET_EYE_Y = 180px ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Üí paste_y ‡∏ï‡∏¥‡∏î‡∏•‡∏ö

- **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
  ```
  eye_y = 80px, TOP_MARGIN = 100px
  ‚Üí crop_y1 = 80 - 100 = -20px
  ‚Üí eye_y_in_crop = 80 - (-20) = 100px (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô boundary)
  ‚Üí boundary check: crop_y1 = 0px
  ‚Üí ‡πÅ‡∏ï‡πà eye_y_in_crop ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô 100px! (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 80px)
  ‚Üí paste_y = 180 - 231 = -51px ‚Üí ‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏î!
  ```

### 4. vertical_align ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- **‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Layout ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ vertical_align ‚Üí ‡πÉ‡∏ä‡πâ default ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å override
- **‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:** ‡∏ö‡∏≤‡∏á layout ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ vertical_align="bottom" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à

---

## ‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### Fix 1: ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏î (Commit: ff0f7e1)

**‡πÑ‡∏ü‡∏•‡πå:** `modules/renderer.py`

#### 1.1 ‡πÄ‡∏û‡∏¥‡πà‡∏° TOP_MARGIN
```python
# ‡∏Å‡πà‡∏≠‡∏ô
TOP_MARGIN = 100  # ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

# ‡∏´‡∏•‡∏±‡∏á
TOP_MARGIN = 150  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏°+‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å
```

#### 1.2 ‡∏•‡∏î BOTTOM_MARGIN (‡∏ä‡∏î‡πÄ‡∏ä‡∏¢)
```python
# ‡∏Å‡πà‡∏≠‡∏ô
BOTTOM_MARGIN = 600

# ‡∏´‡∏•‡∏±‡∏á
BOTTOM_MARGIN = 550  # ‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ crop_height ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏°
```

#### 1.3 ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì eye_y_in_crop ‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á boundary check
```python
# ‚ùå ‡∏Å‡πà‡∏≠‡∏ô (‡∏ú‡∏¥‡∏î!)
eye_y_in_crop = eye_center_y_norm - crop_y1  # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô boundary

# Boundary check
crop_y1 = max(0, crop_y1)  # crop_y1 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÅ‡∏ï‡πà eye_y_in_crop ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô!

# ‚úÖ ‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡∏π‡∏Å!)
# Boundary check
crop_y1 = max(0, crop_y1)
crop_y2 = min(normalized_img.height, crop_y2)

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á boundary check
if kps is not None and len(kps) >= 2:
    eye_y_in_crop = eye_center_y_norm - crop_y1  # ‡πÉ‡∏ä‡πâ crop_y1 ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô boundary ‡πÅ‡∏•‡πâ‡∏ß!
```

#### 1.4 ‡πÄ‡∏û‡∏¥‡πà‡∏° TARGET_EYE_Y
```python
# ‡∏Å‡πà‡∏≠‡∏ô
TARGET_EYE_Y = 180  # ‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Üí paste_y ‡∏ï‡∏¥‡∏î‡∏•‡∏ö

# ‡∏´‡∏•‡∏±‡∏á
TARGET_EYE_Y = 360  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
- TOP_MARGIN = 150px ‚Üí eye_y_in_crop ‚âà 150px
- crop_height = 700px (150 + 550)
- scale 1.2x ‚Üí eye_y_scaled = 150 * (1296/700) = 278px
- paste_y = 360 - 278 = **82px** ‚úÖ (‡∏´‡∏±‡∏ß‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏ô 82px, ‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î!)

---

### Fix 2: ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Commit: 59f80e3, c819078)

**‡πÑ‡∏ü‡∏•‡πå:** `modules/layout.py`

```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 1.5  # ‡∏´‡∏£‡∏∑‡∏≠ 2.0 (‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2  # ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö canvas
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ = 1080 * 1.2 = **1296px**

---

### Fix 3: ‡πÅ‡∏Å‡πâ‡∏ó‡∏∏‡∏Å layout ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (Commit: a925de4)

**‡πÑ‡∏ü‡∏•‡πå:** `modules/layout.py`

#### ‡πÅ‡∏Å‡πâ‡∏ó‡∏±‡πâ‡∏á 7 layouts:

**1. solo_focus**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 0.82
position.y = int(self.height * 0.15)
# ‡πÑ‡∏°‡πà‡∏°‡∏µ vertical_align

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2
position.y = 0
vertical_align = "top"
```

**2. duo_focus**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 1.15
position.y = 0
# ‡πÑ‡∏°‡πà‡∏°‡∏µ vertical_align

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2
position.y = 0
vertical_align = "top"
```

**3. duo_diagonal**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 0.95 (‡∏ã‡πâ‡∏≤‡∏¢), 0.75 (‡∏Ç‡∏ß‡∏≤)  # ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
position.y = int(self.height * 0.12), 0.25  # ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô!

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2  # ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Ñ‡∏ô
position.y = 0
vertical_align = "top"
```

**4. tri_hero**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 1.2  # ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
position.y = 0
# ‡πÑ‡∏°‡πà‡∏°‡∏µ vertical_align

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2
position.y = 0
vertical_align = "top"  # ‡πÄ‡∏û‡∏¥‡πà‡∏°!
```

**5. tri_pyramid**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 1.3 (‡∏Å‡∏•‡∏≤‡∏á), 0.75 (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤)  # ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
position.y = int(self.height * 0.28), 0.25  # ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô!

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2  # ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Ñ‡∏ô
position.y = 0
vertical_align = "top"
```

**6. tri_staggered**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 0.95, 1.15, 0.90  # ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô!
position.y = 0.30, 0.32, 0.40  # ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô!

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2  # ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Ñ‡∏ô
position.y = 0
vertical_align = "top"
```

**7. quad_lineup**
```python
# ‡∏Å‡πà‡∏≠‡∏ô
scale = 0.95  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
position.y = int(self.height * 0.35)

# ‡∏´‡∏•‡∏±‡∏á
scale = 1.2  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
position.y = 0
vertical_align = "top"
```

---

## üéØ ‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

### Character Crop Settings (renderer.py)
```python
TARGET_EYE_DISTANCE = 120  # px - normalize eye distance
TOP_MARGIN = 150           # px - ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡πÑ‡∏õ‡∏ö‡∏ô (‡∏ú‡∏°+‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å)
BOTTOM_MARGIN = 550        # px - ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡πÑ‡∏õ‡∏•‡πà‡∏≤‡∏á (‡∏à‡∏°‡∏π‡∏Å+‡∏õ‡∏≤‡∏Å+‡∏Ñ‡∏≠+‡∏ï‡∏±‡∏ß)
SIDE_MARGIN = 150          # px - ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤

# crop_height = TOP_MARGIN + BOTTOM_MARGIN = 700px
```

### Eye Positioning (renderer.py)
```python
TARGET_EYE_Y = 360  # px - ‡∏ï‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 360px ‡∏à‡∏≤‡∏Å‡∏ö‡∏ô
```

### Layout Scale (layout.py)
```python
scale = 1.2  # ‡∏ó‡∏∏‡∏Å layout ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
```

### Character Size (‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå)
```python
target_h = 1080 * 1.2 = 1296px  # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
```

---

## üìê ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)

### ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (eye_y > TOP_MARGIN):
```
Input:
- eye_y = 200px (‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö)
- TARGET_EYE_DISTANCE = 120px
- eye_distance (‡πÉ‡∏ô‡∏£‡∏π‡∏õ) = 140px
- scale_factor = 120/140 = 0.857x

Normalization:
- eye_y_norm = 200 * 0.857 = 171px
- TOP_MARGIN = 150px
- crop_y1 = 171 - 150 = 21px ‚úÖ (‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö)

Boundary Check:
- crop_y1 = max(0, 21) = 21px (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

Eye Position in Crop:
- eye_y_in_crop = 171 - 21 = 150px ‚úÖ

Final Scaling:
- crop_height = 700px
- target_h = 1296px
- eye_y_scaled = 150 * (1296/700) = 278px

Final Positioning:
- TARGET_EYE_Y = 360px
- paste_y = 360 - 278 = 82px ‚úÖ
- head_top_y = 82px (‡∏´‡∏±‡∏ß‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏ô 82px)
```

### ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (eye_y < TOP_MARGIN):
```
Input:
- eye_y_norm = 80px (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ TOP_MARGIN!)
- TOP_MARGIN = 150px
- crop_y1 = 80 - 150 = -70px ‚ùå (‡∏ï‡∏¥‡∏î‡∏•‡∏ö)

Boundary Check:
- crop_y1 = max(0, -70) = 0px ‚úÖ (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô 0)

Eye Position in Crop (‡∏´‡∏•‡∏±‡∏á boundary):
- eye_y_in_crop = 80 - 0 = 80px ‚úÖ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á boundary!)

Final Positioning:
- eye_y_scaled = 80 * (1296/700) = 148px
- paste_y = 360 - 148 = 212px ‚úÖ
- head_top_y = 212px (‡∏´‡∏±‡∏ß‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î!)
```

---

## üîÑ Landmark-Based Normalization (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)

### ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:
‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ**‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô** + **‡∏ï‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô**

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£:

#### 1. Normalize Eye Distance (‡∏Å‡πà‡∏≠‡∏ô crop)
```python
left_eye = kps[0]   # ‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ [x, y]
right_eye = kps[1]  # ‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ [x, y]

eye_distance = np.linalg.norm(left_eye - right_eye)
# ‡πÄ‡∏ä‡πà‡∏ô 140px (‡∏Ñ‡∏ô‡πÉ‡∏´‡∏ç‡πà), 100px (‡∏Ñ‡∏ô‡πÄ‡∏•‡πá‡∏Å)

TARGET_EYE_DISTANCE = 120  # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ 120px

scale_factor = 120 / eye_distance
# ‡∏Ñ‡∏ô‡πÉ‡∏´‡∏ç‡πà: 120/140 = 0.857x (‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î)
# ‡∏Ñ‡∏ô‡πÄ‡∏•‡πá‡∏Å: 120/100 = 1.2x (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î)

# Resize ‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
normalized_img = source_pil.resize((new_w, new_h), Image.LANCZOS)
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ eye_distance = 120px (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!)

#### 2. Crop ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏ï‡∏≤
```python
# ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ margin ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
TOP_MARGIN = 150
BOTTOM_MARGIN = 550
SIDE_MARGIN = 150

crop_y1 = eye_y - TOP_MARGIN
crop_y2 = eye_y + BOTTOM_MARGIN
crop_x1 = eye_x - (TARGET_EYE_DISTANCE + SIDE_MARGIN)
crop_x2 = eye_x + (TARGET_EYE_DISTANCE + SIDE_MARGIN)

# ‚úÇÔ∏è Crop!
character_img = normalized_img.crop((crop_x1, crop_y1, crop_x2, crop_y2))
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ crop size ‚âà 540x700px (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!)

#### 3. Scale ‡∏ï‡∏≤‡∏° placement.scale
```python
target_h = 1080 * 1.2 = 1296px
aspect_ratio = 540/700 = 0.771
target_w = 1296 * 0.771 = 999px

character_img = character_img.resize((999, 1296), Image.LANCZOS)
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏π‡∏á 1296px (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!)

#### 4. Position ‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
```python
eye_y_in_crop = 150px  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ TOP_MARGIN ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
eye_y_scaled = 150 * (1296/700) = 278px  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô

TARGET_EYE_Y = 360px  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
paste_y = 360 - 278 = 82px  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
```

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 360px ‡∏à‡∏≤‡∏Å‡∏ö‡∏ô (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!) ‚úÖ

---

## üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

### ‚úÖ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:
1. **‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô** - landmark-based normalization ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 100%
2. **‡∏ï‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà 360px** - eye-level positioning ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
3. **‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î** - TOP_MARGIN=150px + TARGET_EYE_Y=360px + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á boundary
4. **‡∏ó‡∏∏‡∏Å layout ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô** - scale=1.2x, y=0, vertical_align="top"

### üìà Metrics:
- Crop Height: **700px** (TOP 150 + BOTTOM 550)
- Character Height: **1296px** (1080 * 1.2)
- Eye Y (on screen): **360px** (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
- Head Top Y: **~10-200px** (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏π‡∏õ, ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö!)

---

## üóÇÔ∏è Commits ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

### ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (2025-11-16):
```
c819078 - ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£: 2.0x ‚Üí 1.5x
ff0f7e1 - FIX COMPLETE: ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡∏≤‡∏î
59f80e3 - ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£: 1.5x ‚Üí 1.2x
fa4c775 - FIX: ‡πÅ‡∏Å‡πâ tri_pyramid + debug log
a925de4 - ‚úÖ COMPLETE FIX: ‡πÅ‡∏Å‡πâ‡∏ó‡∏∏‡∏Å layout ‡πÉ‡∏ä‡πâ scale ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
```

### ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ):
```
cb39417 - FIX: Precise Eye-Level Positioning
```

---

## ‚ö†Ô∏è ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á

### 1. ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô layout scale ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
```python
# ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥!
scale = 1.3  # ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á
scale = 0.75  # ‡∏ï‡∏±‡∏ß‡∏Ç‡πâ‡∏≤‡∏á

# ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô!
scale = 1.2  # ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
```

### 2. ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ position.y ‡πÅ‡∏ó‡∏ô y=0
```python
# ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥!
position.y = int(self.height * 0.35)

# ‚úÖ ‡πÉ‡∏ä‡πâ y=0 ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ TARGET_EYE_Y ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
position.y = 0
```

### 3. ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ vertical_align="top"
```python
# ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô default
CharacterPlacement(...)

# ‚úÖ ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
CharacterPlacement(..., vertical_align="top")
```

### 4. ‡∏≠‡∏¢‡πà‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì eye_y_in_crop ‡∏Å‡πà‡∏≠‡∏ô boundary check
```python
# ‚ùå ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥!
eye_y_in_crop = eye_y - crop_y1
crop_y1 = max(0, crop_y1)  # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà eye_y_in_crop ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó!

# ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏á boundary
crop_y1 = max(0, crop_y1)
eye_y_in_crop = eye_y - crop_y1  # ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô boundary ‡πÅ‡∏•‡πâ‡∏ß
```

---

## üîç ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### ‡∏î‡∏π log ‡∏Å‡∏≤‡∏£ render:
```
üëÅÔ∏è  Eye-based crop: eye_distance=139.5px ‚Üí 120px (scale=0.86x)
üìê Crop before boundary: y1=312, y2=1012
üìê Eye position in crop (after boundary): 150.4px from top
‚úÇÔ∏è  Cropped size: 540x700px
üìê Final size: 999x1296px (scale=1.2x)
üëÅÔ∏è  Eye positioning: eye_y_in_crop=150.4px ‚Üí scaled=278.2px ‚Üí final_y=360px
üë§ Head top at: 82px from canvas top (should be > 0!)
```

### ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤:
- ‚úÖ `eye_distance ‚Üí 120px` (normalize ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
- ‚úÖ `Eye position in crop (after boundary)` ‚âà 150px (TOP_MARGIN)
- ‚úÖ `Cropped size` ‚âà 540x700px (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)
- ‚úÖ `Final size` ‚âà 999x1296px (scale 1.2x)
- ‚úÖ `final_y=360px` (‡∏ï‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
- ‚úÖ `Head top at: XXpx` > 0 (‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏î!)

---

## üìû ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

### ‡∏´‡∏±‡∏ß‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà:
1. ‡πÄ‡∏ä‡πá‡∏Ñ `Head top at:` ‡πÉ‡∏ô log ‚Üí ‡∏ï‡πâ‡∏≠‡∏á > 0
2. ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° `TOP_MARGIN` ‡∏´‡∏£‡∏∑‡∏≠ `TARGET_EYE_Y`

### ‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô:
1. ‡πÄ‡∏ä‡πá‡∏Ñ layout ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ scale ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°
2. ‡πÄ‡∏ä‡πá‡∏Ñ `Cropped size` ‡πÉ‡∏ô log ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤ ‚Üí landmarks ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ kps)

### ‡∏ï‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:
1. ‡πÄ‡∏ä‡πá‡∏Ñ `final_y=` ‡πÉ‡∏ô log ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 360px ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤ ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ vertical_align="top"

---

**üîí ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á - ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏ö!**
